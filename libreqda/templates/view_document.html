{% extends "base.html" %}
{% load i18n %}

{% block head %}
  {{ block.super }}
  <script src="{{ STATIC_URL }}lib/annotator/annotator-full.min.js" type="text/javascript"></script>
  <link href="{{ STATIC_URL }}css/annotator.min.css" rel="stylesheet" type="text/css">
  
  <!-- <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>-->
  
  <script src="{{ STATIC_URL }}lib/jquery.contextMenu/jquery.contextMenu.js" type="text/javascript"></script>
  <script src="{{ STATIC_URL }}lib/jquery.contextMenu/jquery.ui.position.js" type="text/javascript"></script>
  <link href="{{ STATIC_URL }}lib/jquery.contextMenu/jquery.contextMenu.css" rel="stylesheet" type="text/css">
  
  
  
    
{% endblock head %}

{% block topbar_extra %}
{% endblock topbar_extra %}

{% block body %}
  <div class="modal hide fade" id="codeModal">
  </div>

  <div id="documents-menu" class="menu left">
    {% include "view_document_documents_tab.html" %}
  </div>

  <div class="row-fluid">
    <div class="span10 offset1">
      <div class="toolbar move-up">
        <a class="btn left-group-button pull-right" target="_blank" href="{% url browse_categories pid=project.id %}"><i class="icon-tags"></i> {% trans "Categorías" %}</a>
        <a class="btn left-group-button pull-right"><i class="icon-file"></i> {% trans "Informes" %}</a>
        <a class="btn left-group-button pull-right" target="_blank" href="{% url browse_queries pid=project.id %}"><i class="icon-search"></i> {% trans "Consultas" %}</a>
        <a class="btn left-group-button pull-right"><i class="icon-filter"></i> {% trans "Filtros" %}</a>
        <a class="btn left-group-button pull-right" target="_blank" href="{% url browse_annotations pid=project.id %}"><i class="icon-comment"></i> {% trans "Anotaciones" %}</a>
        <a class="btn left-group-button pull-right" target="_blank" href="{% url browse_codes pid=project.id %}"><i class="icon-book"></i> {% trans "Códigos" %}</a>
        <a class="btn left-group-button pull-right"><i class="icon-bookmark"></i> {% trans "Citas" %}</a>
      </div>
    </div>
  </div>
  
  <div class="document-container white-background with-border row-fluid">
    <div class="span9 document-text">
      <h3>{{ document.name }}</h3>
      <div id="doc-text-area">
        {{ document.document.text|linebreaks }}
      </div>
    </div>
    <div class="span3 document-citations">
    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function() {
        setTimeout(function() {
          $('#documents-menu').css('left','-430px');
        }, 250);
        
        // SHOW RIGHT SIDE BARS
        setTimeout(function() {
          $(".annotator-hl").each(function() {
            var offset = $(this).offset().top;            
            
            var new_bar = $('<div/>', {
              'id': 'bar-id-' + offset, //TODO: hacer bien...
              'class': 'citation-bar',
            });
            
            $('.document-citations').append(new_bar);
            new_bar.position({
              my: "top top",
              at: "top",
              of: $(this)
            });
            new_bar.height($(this).height());
            new_bar[0].style.left = null;
          });
          
          $.contextMenu({
            selector: '.document-citations .citation-bar',
            callback: function(key, options) {
              var m = "clicked: " + key + " on " + $(this)[0].id;
              window.console && console.log(m) || alert(m); 
            },
            items: {
              "addcode": {name: "Agregar", icon: "edit"},
            }
          });
          
          $('.document-citations .citation-bar').click(function(ev) {
            ev.preventDefault(); // prevent navigation
            var url = $(this).data("url"); // get the form url
            $.getJSON(url, function(data) { // load the url into the modal
              $('#codeModal').html(data.html);
              $('#codeModal').modal('show');
            });
            return false; // prevent the click propagation
          });

          $('#codeModal').on('submit', 'form', function() {
            $.ajax({ 
              type: $(this).attr('method'), 
              url: this.action, 
              data: $(this).serialize(),
              context: this,
              success: function(data, status) {
                if (data.success) {
                  $('#codeModal').modal('hide');
                } else {
                  $('#codeModal').html(data.html);
                }                
              }
            });
            return false;
          });
          
        }, 750);
        
        
        
        
        Annotator.Plugin.StoreLogger = function (element) {
          return {
            pluginInit: function () {
              this.annotator
                .subscribe("annotationCreated", function (annotation) {                  
                  console.info("The annotation: %o has just been created!", annotation)
                });
              }
          }
        };
        
        $('#doc-text-area').annotator()
          .annotator('addPlugin', 'StoreLogger')
          .annotator('addPlugin', 'Store', {
            prefix: '',
            urls: {
              create:  '{% url annotations_create pid=project.id did=document.id %}',
              read:    '{% url annotations_read pid=project.id did=document.id %}:id',
              update:  '{% url annotations_update pid=project.id did=document.id %}:id',
              destroy: '{% url annotations_destroy pid=project.id did=document.id %}:id',
              search:  '/search/'
            },
            annotationData: {
              // Extra parameters
            },
          });
        
    });
  </script>
{% endblock %}